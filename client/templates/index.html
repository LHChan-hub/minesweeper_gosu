<!DOCTYPE html>
<html>
<head>
    <title>Minesweeper Prediction</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Minesweeper Prediction</h1>
    <button id="resetButton">Reset Board</button>
    <button id="startButton">Start AI</button>
    <div id="game-container">
        <div id="board"></div>
        <div id="solution-board"></div>
    </div>
    <div id="last-action"></div>
    <div id="num-actions"></div>
    <script>
        var solution = [];

        function resetBoard() {
            $.getJSON('/reset', function(data) {
                if (data.error) {
                    $('#board').html('<p>' + data.error + '</p>');
                } else {
                    solution = data.solution;
                    renderBoard(data.solution);
                    $('#last-action').text('');
                    $('#num-actions').text('');
                }
            });
        }

        function startAI() {
            $.getJSON('/predict', function(data) {
                if (data.error) {
                    $('#board').html('<p>' + data.error + '</p>');
                } else {
                    var predictions = data.predictions;
                    var lastAction = data.last_action;
                    var numActions = data.num_actions;
                    function revealCell(index) {
                        if (index >= predictions.length) return;
                        var x = predictions[index].x;
                        var y = predictions[index].y;
                        var reward = predictions[index].reward;
                        var done = predictions[index].done;
                        var state = predictions[index].state;  // 상태 확인용 추가
                        var cell = $('#cell-' + x + '-' + y);
                        if (reward < 0) {
                            cell.addClass('mine');
                        } else {
                            cell.addClass('safe').text(solution[x][y]);
                        }
                        console.log('State at step ' + index + ':', state);  // 상태 출력
                        if (!done) {
                            setTimeout(function() {
                                revealCell(index + 1);
                            }, 1000); // 1초 후 다음 셀 선택
                        }
                    }
                    revealCell(0);

                    var lastX = Math.floor(lastAction / 10);
                    var lastY = lastAction % 10;
                    $('#last-action').text('Last Action: (' + lastX + ', ' + lastY + ')');
                    $('#num-actions').text('Number of Actions: ' + numActions);
                }
            });
        }

        function renderBoard(solution) {
            var board = $('#board');
            var solutionBoard = $('#solution-board');
            board.empty();
            solutionBoard.empty();
            for (var i = 0; i < 10; i++) {
                for (var j = 0; j < 10; j++) {
                    var cell = $('<div class="cell" id="cell-' + i + '-' + j + '"></div>');
                    cell.data('x', i).data('y', j);
                    board.append(cell);

                    var solCell = $('<div class="cell"></div>');
                    if (solution[i][j] == -1) {
                        solCell.addClass('mine');
                    } else {
                        solCell.text(solution[i][j]);
                    }
                    solutionBoard.append(solCell);
                }
                board.append('<br>');
                solutionBoard.append('<br>');
            }
        }

        $(document).ready(function(){
            $('#resetButton').click(function() {
                resetBoard();
            });

            $('#startButton').click(function() {
                startAI();
            });

            $('#board').on('click', '.cell', function() {
                var x = $(this).data('x');
                var y = $(this).data('y');
                alert('주변 지뢰 개수: ' + $(this).text());
            });

            resetBoard();
        });
    </script>
</body>
</html>
